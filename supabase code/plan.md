CREATE TABLE IF NOT EXISTS public.joint_analysis_records (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    dog_id UUID NOT NULL REFERENCES public.dogs(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT timezone('utc'::text, now()) NOT NULL,
    is_baseline BOOLEAN NOT NULL DEFAULT false,
    original_video_filename TEXT NOT NULL,
    processed_video_url TEXT NOT NULL,
    analysis_results JSONB,
    notes TEXT
);

-- 각 강아지별로 is_baseline=true인 레코드는 하나만 존재하도록 하는 인덱스 생성
CREATE UNIQUE INDEX IF NOT EXISTS unique_baseline_per_dog
ON public.joint_analysis_records (dog_id)
WHERE is_baseline = true;

-- 주석 추가 (정보성)
COMMENT ON TABLE public.joint_analysis_records IS '사용자별 AI 관절 분석 기록';
COMMENT ON COLUMN public.joint_analysis_records.is_baseline IS '해당 강아지의 첫 분석(기준점)인지 여부';
COMMENT ON COLUMN public.joint_analysis_records.analysis_results IS 'AI가 추출한 구조화된 분석 데이터 (안정성, 대칭성 등)';
COMMENT ON INDEX unique_baseline_per_dog IS '각 강아지별 기준 분석(is_baseline=true)은 하나만 존재하도록 보장';

-- Row Level Security 활성화
ALTER TABLE public.joint_analysis_records ENABLE ROW LEVEL SECURITY;

-- 기존 정책 삭제 (멱등성 보장)
DROP POLICY IF EXISTS "사용자는 자신의 분석 기록만 접근 가능" ON public.joint_analysis_records;
DROP POLICY IF EXISTS "서비스 역할은 모든 접근 가능" ON public.joint_analysis_records;

-- 사용자 접근 정책 생성
CREATE POLICY "사용자는 자신의 분석 기록만 접근 가능"
ON public.joint_analysis_records
FOR ALL
USING (auth.uid() = user_id);

-- 서비스 역할 정책 생성
CREATE POLICY "서비스 역할은 모든 접근 가능"
ON public.joint_analysis_records
FOR ALL
USING (true);