# [2025-08-02] 자세 분석 신뢰도 개선 및 '자세 점수' 시스템 도입

## 1. 문제 정의: '허리 곧음 정도' 점수의 신뢰성 부족

최초 버전의 '허리 곧음 정도' 기능은, 사용자가 육안으로 보기에 분명히 허리를 곧게 편 강아지의 영상을 분석했음에도 불구하고, 59.9° 와 같이 상식적으로 납득하기 어려운 낮은 점수를 반환하는 심각한 신뢰성 문제를 겪고 있었다.

## 2. 원인 분석 및 해결 과정: A-B 테스트와 점진적 개선

이 문제를 해결하기 위해, 다음과 같은 다단계의 가설 검증 및 개선 과정을 거쳤다.

### 2.1. 1차 가설: 키포인트(Keypoint) 인덱스 오류

가장 먼저, 점수 계산에 사용되는 키포인트의 인덱스 번호가 잘못되었을 것이라는 가설을 세웠다. 특히, '자세 안정성'과 '허리 곧음'을 계산하는 두 함수가 서로 다른 관절 번호를 참조하고 있을 가능성을 의심했다.

- **검증 시도:** AI가 실제로 어떤 키포인트를 보고 있는지 확인하기 위해, 관절 포인트와 연결선을 직접 그려주는 **'시각적 디버그 비디오'** 생성 기능을 백엔드에 추가했다.
- **1차 난관 (코덱 문제):** 디버그 비디오(`mp4`) 생성 시, 서버 환경에 `avc1(H.264)` 코덱이 없어 파일 생성이 실패하는 `FileNotFoundError`가 발생했다.
- **해결:** 호환성이 높은 `MJPG` 코덱과 `.avi` 확장자로 변경하여 파일 생성에 성공했다.
- **2차 난관 (용량 문제):** `MJPG` 코덱은 압축률이 낮아 파일 용량이 매우 컸고, 이로 인해 Supabase 무료 플랜의 업로드 용량 제한(50MB)을 초과하는 `Payload too large` 오류가 발생했다.
- **최종 해결:** 디버그 영상은 Supabase에 업로드하는 대신, 분석 서버의 로컬 URL을 통해 직접 접근하도록 방식을 변경하여 문제를 해결했다.

### 2.2. 근본 원인 발견: 계산 로직의 불일치 및 부정확성

긴 디버깅 과정 끝에, 다음과 같은 두 가지 근본 원인을 찾아냈다.

1.  **관절 번호 불일치:** '자세 안정성' 함수는 올바른 어깨/엉덩이 관절(`5,6,11,12`)을 사용했지만, '허리 곧음' 함수는 완전히 다른 부위(`6,7,12,13,14`)를 참조하여 의미 없는 각도를 계산하고 있었다.
2.  **잘못된 기준:** "등 중앙(Withers)" 키포인트는 모델이 안정적으로 찾아내지 못하여, 이 점에 의존하는 3점 각도 측정 방식 자체가 신뢰도가 낮았다.

### 2.3. 2차 가설: 계산 방식의 한계 및 개선

���못된 계산 방식을 버리고, 더 안정적인 **"벡터 내적(Dot Product)"**을 이용하여 "강아지 척추선"과 "완벽한 수평선" 사이의 각도를 측정하는 새로운 로직을 도입했다.

- **초기 결과:** 131.6° 등 이전보다 훨씬 합리적인 결과가 나왔으나, 완벽한 자세임에도 180점에 가깝지 않은 문제가 발생했다.
- **원인 분석:** 스마트폰의 "광각 렌즈"로 인한 **원근 왜곡** 때문에, 실제로는 수평인 척추가 카메라에는 기울어져 보이는 현상이 주된 원인으로 추정되었다.

## 3. 최종 해결책: '자세 점수' 시스템 도입

절대적인 '각도(°)' 값은 카메라 왜곡 등 외부 요인 때문에 신뢰도를 100% 확보하기 어렵다는 결론에 도달했다. 이에, 패러다임을 전환하여 **사용자가 더 직관적으로 이해할 수 있는 '점수(점)' 시스템**을 도입하기로 최종 결정했다.

### 3.1. 비선형 점수 변환 (Non-linear Scoring)

- **개념:** "각도"를 "점수"로 변환하되, 높은 각도(더 좋은 자세)에 더 많은 보너스 점수를 부여하는 **비선형 변환** 방식을 채택했다.
- **최종 공식 (사인 곡선):** 90°~180° 사이의 각도 값을, 0~100점 사이의 점수로 변환하기 위해 **사인(Sine) 곡선**을 이용한 공식을 최��� 채택했다. 이 방식은 90° 근처에서는 점수가 완만하게, 180° 근처에서는 점수가 급격하게 오르는, 우리의 의도에 가장 적합한 곡선을 제공한다.

```python
# main.py - 최종 적용된 점수 변환 로직
def angle_to_score(mean_angle):
    if mean_angle < 90: return 0.0
    if mean_angle > 180: mean_angle = 180
    
    # 90~180 범위를 0~1 범위로 정규화
    x = (mean_angle - 90) / 90
    
    # 사인 곡선을 이용하여 0~100점 사이의 점수로 변환
    score = math.sin(x * math.pi / 2) * 100
    return score
```

### 3.2. 최종 안정성 확보: 파일 이름 정규화

테스트 과정에서, "꽁지.mp4"와 같이 **한글 파일 이름을 업로드할 경우, Supabase에서 `InvalidKey` 오류가 발생**하는 문제를 발견했다. 이를 해결하기 위해, 파일 업로드 시 파일 이름에서 한글, 공백 등을 제거하고 **안전한 영문/숫자 기반의 이름으로 자동 변환**하는 정규식(Regex) 기반의 파일 이름 정규화 로직을 백엔드에 추가했다.

## 4. 시스템 변경 사항 요약

-   **백엔드 (`main.py`):**
    -   `calculate_spine_curvature` 함수를, 벡터 내적 및 사인 곡선 기반의 **'자세 점수'** 계산 로직으로 전면 교체했다.
    -   한글 등 비-ASCII 문자를 포함한 파일 이름 업로드 시, 이를 안전한 이름으로 자동 변환하는 로직을 추가했다.
-   **프론트엔드 (4개 파일):**
    -   `PostureAnalysisPage.tsx`, `LatestAnalysisResultCard.tsx`, `JointAnalysisHistoryList.tsx`, `AnalysisDetailView.tsx`
    -   '허리 곧음 정도'라는 명칭을 **'자세 점수'**로 변경했다.
    -   단위를 **`°`**에서 **`점`**으로 변경했다.
    -   관련 설명 문구를 새로운 '자세 점수' 시스템의 의미에 맞게 자연스럽게 수정했다.

## 5. 결론

이번 대규모 개선 작업을 통해, '자세 분석' 기능은 단순한 각도 측정기를 넘어, **외부 요인의 영향을 최소화하고 사용자가 직관적으로 이해할 수 있는 '자세 점수' 시스템으로 발전**했다. 특히, 수많은 시행착오와 디버깅을 거쳐 '벡터 내적'과 '사인 곡선'을 결합한 최종 계산 로직을 도입함으로써, 기능의 **신뢰성과 안정성을 비약적으로 향상**시켰다.
