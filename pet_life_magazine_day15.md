# Pet-Life Magazine 개발일지 (Day 15)

**목표:** YOLOv8 모델(`best.pt`)을 웹 앱에 통합하여, 사용자가 영상을 업로드하고 AI 분석 결과를 확인할 수 있는 'AI 자세 분석' 기능을 완성한다.

## 📝 주요 개발 내용

### 1. 백엔드 API 구축 및 고도화 (FastAPI)
- **초기 구축:** `plan.md`에 계획된 대로 FastAPI 서버를 구축하고, `CORS` 및 정적 파일 서빙 설정을 추가하여 프론트엔드와의 연동 문제를 사전에 해결했다.
- **DB 연동:** Supabase와 연동하여 사용자별/강아지별 분석 기록을 저장할 `joint_analysis_records` 테이블을 신규 생성했다. 이 과정에서 `dogs` 테이블의 `id` 타입이 `uuid`임을 확인하고 스키마를 수정하여 데이터 정합성을 확보했다.
- **핵심 기능 구현:**
    - **'기준점(Baseline)' 개념 도입:** 특정 강아지의 첫 분석 결과를 `is_baseline=true`로 저장하여, 모든 미래 분석의 비교 기준으로 삼는 핵심 로직을 구현했다.
    - **핵심 지표 계산:** YOLO 분석 결과로부터 '안정성', '대칭성', '보폭' 등 의미 있는 지표를 계산하는 함수를 추가했다. (현재는 시뮬레이션 값)
- **안정성 확보:**
    - **비디오 코덱 문제 해결:** 초기 결과물인 `.avi`나 `mp4v` 코덱의 `.mp4` 파일이 웹 브라우저에서 재생되지 않는 문제를 발견했다. `OpenCV`를 사용하여, 웹에서 가장 널리 호환되는 **H.264 (`avc1`) 코덱**으로 영상을 자동 변환하는 로직을 추가하여 문제를 최종 해결했다.
    - **API 오류 처리 개선:** `supabase-py` 라이브러리 버전업에 따른 응답 객체 변경을 파악하고, `try...except APIError` 구문을 사용하여 DB 저장 오류 처리 로직을 안정적으로 수정했다.

### 2. 프론트엔드 UI/UX 개발 및 리팩토링 (React, shadcn/ui)
- **기능 명칭 확정:** 사용자의 직관적인 이해를 돕기 위해, 'AI 관절 추적' -> 'AI 보행 분석' -> **'AI 자세 분석'** 으로 최종 명칭을 확정했다.
- **페이지 역할 분담:**
    - **분석 페이지 (`PostureAnalysisPage`):** '빠른 실행과 즉각적인 요약 피드백' 역할로 한정했다. 분석 완료 후에는 상세 결과를 보여주는 대신, 완료 메시지와 함께 히스토리 페이지로 이동하는 버튼만 제공하도록 UI를 단순화했다.
    - **히스토리 페이지 (`PostureAnalysisHistoryPage`):** '상세 데이터 확인 및 변화 추적'의 유일한 창구로 역할을 명확히 했다.
- **데이터 동기화 문제 해결:**
    - 페이지 이동 시 데이터가 갱신되지 않는 문제를 해결하기 위해, `useState`/`useEffect` 기반의 데이터 로직을 **`React Query` (`useQuery`)** 기반으로 전면 리팩토링했다.
    - `useUserDogs`라는 새로운 훅을 만들어 여러 마리의 강아지를 지원하고, `useJointAnalysisHistory` 훅과 연동하여 항상 최신 데이터를 자동으로 동기화하도록 시스템을 개선했다.
- **네비게이션 구조 개선:**
    - **레이아웃 문제 해결:** 신규 페이지들이 `AppCore` 레이아웃 외부에서 렌더링되어 서브 네비게이션이 보이지 않는 문제를, `App.tsx`와 `Index.tsx`의 라우팅 구조를 수정하여 해결했다.
    - **서랍형 메뉴 구현:** `DropdownMenu`가 `overflow` 속성과 충돌하는 문제를 발견하고, `shadcn/ui`의 **`NavigationMenu`** 컴포넌트로 교체하여 더 세련되고 안정적인 서랍형 네비게이션을 최종 구현했다.

## ✅ 최종 성과
- 사용자가 영상을 업로드하여 AI 자세 분석을 실행하고, 그 결과가 웹 표준 영상 포맷(.mp4/H.264)으로 변환되어 DB에 사용자별/강아지별로 저장되며, 히스토리 페이지에서 항상 최신 데이터를 확인할 수 있는 **End-to-End 기능의 MVP를 성공적으로 완성했다.**
- 이 과정에서 발생한 백엔드(코덱, DB API)와 프론트엔드(데이터 동기화, 네비게이션)의 복합적인 문제들을 체계적으로 진단하고 해결하는 경험을 축적했다.

---

## 🚀 Day 15 추가 작업: 대시보드 및 핵심 레이아웃 안정화

- **목표:** 복잡했던 대시보드 페이지를 사용자 친화적으로 개편하고, 반복적으로 발생하던 레이아웃 문제를 근본적으로 해결하여 앱의 첫인상을 개선한다.

### 1. 대시보드 콘텐츠 재배치
- **문제점:** 기존 대시보드는 기능 버튼과 정보성 콘텐츠(리마인더, 팁, 미션)가 혼재하여 복잡하고 스크롤이 길었다.
- **해결책:** 정보의 성격에 따라 콘텐츠를 재배치하여 대시보드의 역할을 '핵심 기능 런처'로 명확히 했다.
    - **'강아지 리마인더'** → **'내 프로필' 페이지**로 이동 (`DogProfilePage.tsx`)
    - **'오늘의 팁', '오늘의 미션'** → **'AI 훈련 추천' 페이지**로 이동 (`AiTrainingRecommender.tsx`)
    - **대시보드**에는 '환영 메시지'와 핵심 기능 버튼들만 남겨 매우 깔끔하게 개선했다.

### 2. 고질적인 레이아웃 문제 해결
- **문제점:** 콘텐츠 양과 상관없이 페이지 하단에 항상 불필요한 빈 공간이 생기는 문제가 지���적으로 발생했다.
- **원인 분석:** 단일 컴포넌트가 아닌, **전체 레이아웃 계층의 상호작용**이 문제의 원인이었다. 최상위 레이아웃(`MainLayoutV2.tsx`)부터 페이지(`DashboardPage.tsx`), 콘텐츠(`DashboardContent.tsx`)에 이르기까지 `min-h-screen`, `flex: 1` 등의 높이 관련 스타일이 충돌하며 문제를 일으키고 있었다.
- **최종 해결:** Top-Down 방식으로 접근하여, `MainLayoutV2.tsx`가 `min-h-screen`과 `flex: 1`으로 전체 틀을 잡고, 하위 컴포넌트들은 내부 콘텐츠 높이에 맞게 자연스럽게 채워지도록 모든 레이아웃 관련 스타일을 체계적으로 정리하여 문제를 완벽히 해결했다.

### 3. 사용자 경험(UX) 개선
- **Joyride 기능 개선:** 온보딩 투어의 단계(`tourSteps`)를 별도 파일(`lib/tourSteps.ts`)로 분리하여 코드의 가독성과 유지보수성을 높이고, 최신 버튼 구성에 맞게 내용을 업데이트했다.
- **버튼 디자인 개선:** 대시보드의 모든 기능 버튼들의 크기(padding)와 텍스트, 아이콘 크기를 늘려 시각적 안정감을 주고 사용자가 누르기 편하도록 개선했다.
- **코드 정리:** `MainLayoutV2.tsx`로 대체되어 더 이상 사용하지 않는 `MainLayout.tsx` 파일을 삭제하여 프로젝트를 정리했다.

### 4. 하단 네비게이션 및 전체 레이아웃 안정화 (추가)
- **하단 네비게이션 간격 문제 해결:** `WoofpediaBottomNav`의 아이콘 간격이 불균일했던 문제를, 'AI 기능' 버튼의 스타일을 다른 버튼들과 통일시켜 시각적으로 완벽히 균등하게 수정했다.
- **조건부 기능 접근 로직 개선:**
    - **문제점:** `localStorage`에 의존하던 기존 온보딩 확인 로직은 다른 기기에서 접속 시 동기화되지 않는 문제가 있었다.
    - **해결책:** Supabase DB를 직접 조회하는 `useDogProfile` 훅을 활용하여, **`dogInfo` 객체의 존재 유무**를 "온보딩 완료"의 기준으로 삼는 방식으로 리팩토링했다. 이는 DB를 진실의 원천(Source of Truth)으로 삼는 훨씬 안정적이고 정확한 방법이다. 이 로직을 'AI 훈련 추천', '챗봇', '자세 분석' 등 모든 핵심 AI 기능에 일괄 적용했다.
- **모바일 화면 흔들림 문제 해결:** 스크롤 시 모바일 브라우저 주소창 크기 변화로 `100vh`가 재계산되며 화면이 흔들리던 고질적인 문제를, `MainLayoutV2.tsx`의 `minHeight` 단위를 **`100dvh`**로 변경하여 완벽하게 해결했다.
- **푸터 가림 문제 해결:** 고정 하단 네비게이션에 푸터가 가려지는 문제를, `<Footer />` 컴포넌트를 `<main>` 태그 안으로 이동시켜 `main`의 `padding-bottom`이 적용되도록 구조를 변경하여 해결했다.

## 📘 오늘의 핵심 배움
- **레이아웃 디버깅의 교훈:** 특정 컴포넌트의 레이아웃 문제가 해결되지 않을 때는, 그 컴포넌트만 보지 말고 **상위 레이아웃부터 시작하여 전체 컴포넌트 계층의 높이와 Flexbox 관련 스타일이 어떻게 상호작용하는지**를 반드시 분석해야 한다. 문제의 근본 원인은 종종 예상치 못한 상위 컴포넌트에 있다.
- **모바일 `100vh` 문제:** 모바일 브라우저에서 스크롤 시 화면이 흔들리는 현상은 `100vh` 단위의 재계산 때문이며, 이를 해결하기 위한 가장 좋은 방법은 **`100dvh` (Dynamic Viewport Height)**를 사용하는 것이다.
- **상태 관리의 신뢰성:** 사용자의 온보딩 완료 여부와 같은 중요한 상태는 `localStorage`보다 **Supabase DB에서 직접 조회한 데이터(`dogInfo`의 존재 유무)를 기준**으로 판단하는 것이 여러 기기에서의 일관성과 데이터 신뢰성 측면에서 훨씬 안정적이다.
